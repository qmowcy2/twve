/***
|editable|k
|''Name:''|twve.core|
|''Description:''|Core codes of twve, the ~TiddlyWiki View mode Editor, providing easy access to the defining wiki text corresponding to a DOM element, and the synchronization capability for multiply transcluded copies of a tiddler.|
|''Author:''|Vincent Yeh (qmo.wcy2@gmail.com)|
|''Source:''|* (minimized) http://twve.tiddlyspot.com/#twve.core.min / http://twve.tiddlyspace.com/#twve.core.min <br>* (regular) http://twve.tiddlyspot.com/#twve.core / http://twve.tiddlyspace.com/#twve.core|
|''Type:''|plugin|
|''Version:''|3.2.0|
|''Status:''|This plugin is still under development.<br>You are welcome to try and send feedback. :-)|
|''Date:''|2014/11/21 said goodbye to jQuery <br>2014/05/13 released 3.0.0 <br>2014/01/18 collected from TWElement, TWtid and TWted|
|''License:''|MIT|
|''Core Version:''|2.7.0|

!!Options
Look for [[twve.core Options]] in the system Options panel.
***/

// @@display:none;
//{{{
"undefined"==typeof twve&&(twve={});version.extensions.twve={major:3,minor:2,revision:0,date:new Date("2014/11/21")};
config.macros.twveCoreOptions={identifyWebkitBrowser:function(){config.browser.isSafari&&config.browser.isChrome&&(config.browser.isSafari=!1,/opr/.test(config.userAgent)&&(config.browser.isOpera=!0,config.browser.isChrome=!1))},init:function(){void 0===config.options.chktwveCoreEnabled&&(config.options.chktwveCoreEnabled=void 0===config.options.chkTWtidEnabled?!0:config.options.chkTWtidEnabled);void 0===config.options.chktwveCoreShowFocus&&(config.options.chktwveCoreShowFocus=void 0===config.options.chkTWtidShowFocus?
!0:config.options.chkTWtidShowFocus);merge(config.optionsDesc,{chktwveCoreEnabled:"Enable ''twve.core''.",chktwveCoreShowFocus:"Show focus borders."});twve.tiddler.prePopupShow=Popup.show;Popup.show=twve.tiddler.popupShow;twve.tiddler.preRefreshTiddler=story.refreshTiddler;story.refreshTiddler=twve.tiddler.refreshTiddler;twve.tiddler.preTabsSwitchTab=config.macros.tabs.switchTab;config.macros.tabs.switchTab=twve.tiddler.tabsSwitchTab;twve.tiddler.preTiddlerTransclude=config.macros.tiddler.transclude;
config.macros.tiddler.transclude=twve.tiddler.tiddlerTransclude;twve.tiddler.preSliderHandler=config.macros.slider.handler;config.macros.slider.handler=twve.tiddler.sliderHandler;twve.tiddler.preOnClickSlider=config.macros.slider.onClickSlider;config.macros.slider.onClickSlider=twve.tiddler.onClickSlider;config.browser.isIE11=/\bnt\b(.*?)11/.test(config.userAgent);config.browser.isIE1076=/msie 7(.*?)trident\/6/.test(config.userAgent);config.browser.isIE10=/msie 10/.test(config.userAgent)||config.browser.isIE1076;
config.browser.isIE9=/msie 9/.test(config.userAgent);config.browser.isIE975=/msie 7(.*?)trident\/5/.test(config.userAgent);config.browser.isIE8=/msie 8/.test(config.userAgent);config.browser.isIE874=/msie 7(.*?)trident\/4/.test(config.userAgent);config.browser.isIE&&(!config.browser.isIE11&&!config.browser.isIE10&&!config.browser.isIE1076&&!config.browser.isIE9&&!config.browser.isIE975&&!config.browser.isIE8&&!config.browser.isIE874)&&displayMessage("''twve'' message: Unsupported IE version.\n\n "+
config.userAgent+"\n\nPlease inform the author at qmo.wcy2@gmail.com. Thanks a lot.");config.browser.isWin7=/nt 6\.1/.test(config.userAgent);config.browser.isWin8=/nt 6\.3/.test(config.userAgent);config.browser.isWinXP=/nt 5\.1/.test(config.userAgent);config.browser.isAndroid=/android/.test(config.userAgent);config.browser.isiOS=/ip(.*?)mac/.test(config.userAgent);config.macros.twveCoreOptions.identifyWebkitBrowser();window.addEventListener("resize",function(b){twve.tiddler.resize(b||window.event)});
void 0===config.options.chktwveCoreEditWrappers&&(config.options.chktwveCoreEditWrappers=!1);merge(config.optionsDesc,{chktwveCoreEditWrappers:"Edit wrappers and tiddler title, default to false<br>(The ''twve.extra'' will automatically enable this feature, regardless of this setting)."});void 0===config.options.chktwveCorePreview&&(config.options.chktwveCorePreview=void 0===config.options.chkTWtedPreview?!0:config.options.chkTWtedPreview);void 0===config.options.txttwveCorePreviewHeight&&(config.options.txttwveCorePreviewHeight=
void 0===config.options.txtTWtedPreviewMaxHeight?"15":config.options.txtTWtedPreviewMaxHeight);void 0===config.options.txttwveCoreMinEditWidth&&(config.options.txttwveCoreMinEditWidth=6);void 0===config.options.txttwveCorePreviewCaret&&(config.options.txttwveCorePreviewCaret=void 0===config.options.txtTWtedPreviewCaret?"|":config.options.txtTWtedPreviewCaret);/^[0-9]+$/.test(config.options.txttwveCorePreviewCaret)&&(config.options.txttwveCorePreviewCaret=String.fromCharCode(1*config.options.txttwveCorePreviewCaret));
void 0===config.options.chktwveCoreConfirmToDelete&&(config.options.chktwveCoreConfirmToDelete=void 0===config.options.chkTWtedConfirmToDelete?!0:config.options.chkTWtedConfirmToDelete);void 0===config.options.chktwveCoreClickAway&&(config.options.chktwveCoreClickAway=void 0===config.options.chkTWtedClickAway?!0:config.options.chkTWtedClickAway);void 0===config.options.chktwveCoreManualSave&&(config.options.chktwveCoreManualSave=void 0===config.options.chkTWtedManualSave?!1:config.options.chkTWtedManualSave);
void 0===config.options.chktwveCoreManualUpload&&(config.options.chktwveCoreManualUpload=void 0===config.options.chkTWtedManualUpload?!1:config.options.chkTWtedManualUpload);merge(config.optionsDesc,{chktwveCorePreview:"Enable previewer. Default to true.",txttwveCoreMinEditWidth:"Minimum edit box width (characters). Default value is 6.",txttwveCorePreviewHeight:"Previewer max height (lines of text). Default to 15.",txttwveCorePreviewCaret:"Caret in the previewer. Default to vertical line (|)",chktwveCoreConfirmToDelete:"Confirm before deleting elements.",
chktwveCoreClickAway:"Click away to accept changes.",chktwveCoreManualSave:'Save changes to file manually. If true, a button labeled "S" will be provided for manual save. Otherwise the file will be saved each time a change is accepted.',chktwveCoreManualUpload:'Upload changes to server manually. If true, a button labeled "U" will be provided for manual upload. Otherwise all changes will be uploaded each time a change is accepted.'});twve.tiddler.preEditHandler=config.commands.editTiddler.handler;
config.commands.editTiddler.handler=twve.tiddler.editHandler;twve.tiddler.precloseTiddler=story.closeTiddler;story.closeTiddler=twve.tiddler.closeTiddler;twve.tiddler.preSaveHandler=config.commands.saveTiddler.handler;config.commands.saveTiddler.handler=twve.tiddler.saveHandler;twve.tiddler.preCancelHandler=config.commands.cancelTiddler.handler;config.commands.cancelTiddler.handler=twve.tiddler.cancelHandler;twve.tiddler.preSaveChanges=saveChanges;saveChanges=twve.tiddler.saveChanges;twve.wrapper.prepareElements=
twve.heading.prepareElements;var a=config.shadowTiddlers.OptionsPanel,b=a.indexOf("----");config.shadowTiddlers.OptionsPanel=a.substring(0,b)+"----\n[[twve.core Options|twve.core Options]]\n"+a.substring(b);merge(config.shadowTiddlers,{"twve.core Options":"<<twveCoreOptions>>"});twve.tiddler.registerWrapper(twve.tiddlerTitle);twve.tiddler.registerWrapper(twve.viewer);twve.tiddler.registerWrapper(twve.tabContent);twve.tiddler.registerWrapper(twve.tiddlerSpan);twve.tiddler.registerWrapper(twve.sliderPanel)},
order:{chktwveCoreEnabled:0,chktwveCoreShowFocus:1,chktwveCoreEditWrappers:2,txttwveCoreMinEditWidth:3,txttwveCorePreviewHeight:4,chktwveCorePreview:5,txttwveCorePreviewCaret:6,chktwveCoreConfirmToDelete:7,chktwveCoreClickAway:8,chktwveCoreManualSave:9,chktwveCoreManualUpload:10},collectOptions:function(a,b){var c=[],d;for(d in config.options)if(0<=d.indexOf(a)){var e=config.optionsDesc[d];if(e){var f=e.indexOf(".");-1<f?"twve"==e.substring(f-4,f)&&(f=e.indexOf(".",f+1),-1==f?f=e.length:f++):f=e.length;
c[c.length]="\n|<<option "+d+">>|"+e.substring(0,f)+" |"}}b&&c.sort(function(a,c){var d=a.substring(a.indexOf(" ")+1,a.indexOf(">>")),e=c.substring(c.indexOf(" ")+1,c.indexOf(">>"));return b[d]>b[e]?1:-1});return c},prepareOptionsTable:function(a,b,c){a="|"+a+"|c\n| Value | Description |h";b=this.collectOptions(b,c);c=0;for(var d=b.length;c<d;c++)a+=b[c];return a},showOptionsTable:function(a,b,c,d){var e=document.createElement("div");a.appendChild(e);a=this.prepareOptionsTable(b,c,d);wikify(a,e);
e=e.querySelector("table");twve.node.setDimension(e,"35em");twve.node.setDimension(e.querySelectorAll("input"),"5em")},handler:function(a){config.macros.twveCoreOptions.showOptionsTable(a,"''twve.core'' Options","twveCore",config.macros.twveCoreOptions.order)}};
twve.object={isCollection:function(a){return a&&void 0!==a.length&&"object"==typeof a},level:0,toString:function(a){switch(typeof a){case "function":return"function";case "object":if(!a)return a;if(a.nodeType)return twve.node.info(a);if(a.title&&a.modifier)return"{title: "+a.title+" ...}";for(var b="{",c=twve.object.keys(a),d=0,e=c.length;d<e;d++){var b=b+((0==d?"":", ")+"\n\t"+c[d]+":"),f=a[c[d]];f?5>++twve.object.level&&(b+=twve.object.toString(f),--twve.object.level):b+=f}return b+"\n}";default:return a}},
keys:function(a,b){var c=[],d;for(d in a)if(b||"function"!=typeof a[d])c[c.length]=d;return c},copyKey:function(a,b,c){switch(typeof b[c]){case "string":case "number":case "boolean":case "function":a[c]=b[c];break;default:if(!b[c])break;a[c]=twve.object.create();for(var d=twve.object.keys(b[c],!0),e=0,f=d.length;e<f;e++)twve.object.copyKey(a[c],b[c],d[e])}return a},copyKeys:function(a,b,c){for(var d=0,e=c.length;d<e;d++)twve.object.copyKey(a,b,c[d]);return a},create:function(a){var b={clone:function(){return twve.object.create(b)},
copyKey:function(a,d){return twve.object.copyKey(b,a,d)},keys:function(){return twve.object.keys(b)},copyFrom:function(a,d){return twve.object.copyKeys(b,a,d||a.keys())},toString:function(){return twve.object.toString(b)},created:function(a){return a?b.copyFrom(a):b}};return b.created(a)}};
twve.text={markupTags:function(){var a=twve.tags.create(["'",'"'],["'",'"']);a.clone=function(){return twve.text.markupTags()};return a},tiddlerSlice:function(a){if(!a)return"";var b=a.indexOf(config.textPrimitives.sliceSeparator);return-1<b?a.substring(b+config.textPrimitives.sliceSeparator.length):""},sectionTitle:function(a){for(var b=0;/[! \t]/.test(a.charAt(b));b++);return 0<b?a.substring(b):a},tiddlerSection:function(a){if(!a)return"";var b=a.indexOf(config.textPrimitives.sectionSeparator);
return-1<b?(a=a.substring(b+config.textPrimitives.sectionSeparator.length),a=twve.text.sectionTitle(a),a.replace("\u2014","--")):""},tiddlerTitle:function(a){if(!a)return"";var b=a.indexOf(config.textPrimitives.sectionSeparator);-1==b&&(b=a.indexOf(config.textPrimitives.sliceSeparator));return-1<b?a.substring(0,b):a},headerToSkip:function(a){var b=a.lastIndexOf("?");return 0<b&&b<a.length-1&&(a=a.substring(b+1),/^\d$/.test(a))?1*a:0},removeHeaderTail:function(a){var b=a.lastIndexOf("?");0<b&&(b<a.length-
1&&!/[\D]/.test(a.substring(b+1)))&&(a=a.substring(0,b));return a},lastIndexOf:function(a,b,c,d){if("string"==typeof b)c.ndx=a.lastIndexOf(b,c.ndx),c.matched=-1<c.ndx?b:"";else{var e=[],f;for(f=0;f<b.length;f++)e[f]=a.lastIndexOf(b[f],c.ndx);c.ndx=e[0];c.matched=-1<c.ndx?b[0]:"";a=c;for(f=1;f<b.length;f++)-1!=e[f]&&(-1==c.ndx||!d&&e[f]>c.ndx?(c.ndx=e[f],c.matched=b[f]):(a.next=twve.position.create(e[f],b[f]),a=a.next))}return c},indexOf:function(a,b,c,d){if("string"==typeof b)c.ndx=a.indexOf(b,c.ndx),
c.matched=-1<c.ndx?b:"";else{var e=[],f;for(f=0;f<b.length;f++)e[f]=a.indexOf(b[f],c.ndx);c.ndx=e[0];c.matched=-1<c.ndx?b[0]:"";for(f=1;f<b.length;f++)-1!=e[f]&&(-1==c.ndx||!d&&e[f]<c.ndx?(c.ndx=e[f],c.matched=b[f]):c.next=twve.position.create(e[f],b[f]))}return c},skipToActive:function(a,b,c,d,e){c?"number"==typeof c&&(c=twve.position.create(c)):c=twve.position.create(0);d?"number"==typeof d&&(d=twve.position.create(d)):d=twve.position.create(a.length);var f=twve.position.create(c),f=twve.text.indexOf(a,
b,f);if(f.ndx==c.ndx)return f;if(f.ndx>d.ndx)return f.ndx=-1,f;e||(e=twve.tags.inactiveTags());for(var g=twve.position.create(f);f.ndx>c.ndx&&f.ndx<d.ndx&&(g=e.encloses(a,f.ndx,c,d));)f.ndx=g.ndx+g.matched.length,f=twve.text.indexOf(a,b,f);if(f.ndx<c.ndx||f.ndx>d.ndx)f.ndx=-1;return f},consecutiveLinesEnd:function(a,b,c,d,e){var f=0;switch(typeof b){case "number":f=b;break;case "object":b.ndx&&(f=b.ndx)}b=a.length;if("\n"==a.charAt(f))f++;else for(;0<f&&"\n"!=a.charAt(f-1);)f--;var g=twve.leveledElement.getLevel(a,
f,d),h=twve.position.create(f,"\n");if(0==g)return h;h.ndx=a.indexOf(h.matched,f);if(-1==h.ndx)return h.ndx=b,h.matched="",h;e||(e=twve.tags.create("\n"+a.substring(f,f+g),"\n"));f=twve.position.create(h);do{f=twve.text.indexOf(a,e.open,f);if(f.ndx!=h.ndx||!c&&twve.leveledElement.getLevel(a,f.ndx+1,d)!=g)break;h.ndx=f.ndx+f.matched.length;h=twve.text.indexOf(a,e.exactCloseTag(f.matched).close,h);if(-1==h.ndx){h.ndx=b;h.matched="";break}f.ndx=h.ndx}while(1);return h},skipStyleText:function(a){if(!a.length||
/^[ @]/.test(a))return 0;var b=0,c,d;do if(c=a.indexOf(":",b+1),0<c){d=a.indexOf("@@",b);if(0<=d&&d<c)return b;d=a.indexOf(";",c+1);if(d>c){if(/[\s\,\.]/.test(a.substring(c+1,d)))return b;b=d+1}else return b}else return b;while(1)},removeStyleText:function(a){if(!a)return"";var b=twve.text.skipStyleText(a);return b<a.length?a.substring(b):""}};
twve.tags={_inactive_tags:null,inactiveTags:function(){twve.tags._inactive_tags||(twve.tags._inactive_tags=twve.pre.markupTags().merge(twve.code.markupTags()).merge(twve.link.markupTags()).merge(twve.tags.create('"""','"""')),twve.tags._inactive_tags.clone=function(){return twve.tags.create()});return twve.tags._inactive_tags},create:function(a,b){var c=twve.object.create();c.sameTag=function(b,a){if(b){if(!a)return!1}else return a?!1:!0;if("string"==typeof b){if("string"==typeof a)return b==a;var c=
twve.position.create(0),c=twve.text.indexOf(b,a,c);return 0<=c.ndx}if("string"==typeof a)return c=twve.position.create(0),c=twve.text.indexOf(a,b,c),0<=c.ndx;if(b.length!=a.length)return!1;for(c=0;c<b.length;c++)if(b[c]!=a[c])return!1;return!0};c.is=function(b){return c.sameTag(c.open,b.open)&&c.sameTag(c.close,b.close)};c.clone=function(){return twve.tiddler.markupTags(c)||twve.tags.create(c)};c.firstTagString=function(b,a,c){var g=c,h=g.length;"\n"==g.charAt(0)&&"\n"!=b.charAt(0)&&(g=g.substring(1),
h--);b.substring(0,h)==g?(a.ndx=0,a.matched=c):(a.ndx=-1,a.matched="");return a};c.firstOpenTag=function(b,a){if("string"==typeof c.open)c.firstTagString(b,a,c.open);else for(var f=0;f<c.open.length&&!(c.firstTagString(b,a,c.open[f]),0==a.ndx);f++);return a};c.nextOpenTag=function(b,a,f){if(0>=a.ndx){c.firstOpenTag(b,a);if(0==a.ndx)return a;a.ndx=0}else"\n"!=b.charAt(a.ndx)&&"\n"==b.charAt(a.ndx-1)&&a.ndx--;return twve.text.skipToActive(b,c.open,a,null,f)};c.exactCloseTag=function(b){if(b&&"object"==
typeof c.open){var a=c.clone();a.open=b;a.close="object"==typeof c.close?c.close[c.open.indexOf(b)]:c.close;return a}return c};c.lastCloseTag=function(b,a,f){f||(f=b.length);var g=c.close,h=g.length;"\n"==c.close.charAt(h-1)&&"\n"!=b.charAt(f-1)&&(g=g.substring(0,--h));b.substring(f-h)==g?(a.ndx=f-h,a.matched=g):(a.ndx=-1,a.matched="");return a};c.matchedCloseTag=function(b,a,f,g){var h=a.ndx;a=twve.text.skipToActive(b,c.close,a,null,g);if(-1<a.ndx)return a;a.ndx=h;return c.lastCloseTag(b,a,f)};c.encloses=
function(b,a,f,g){if(0==a||a>=b.length-1)return null;f=twve.position.create(f);g=twve.position.create(g);0>f.ndx&&(f.ndx=0);if(g.ndx<=f.ndx||g.ndx>b.length)g.ndx=b.length;var h=twve.position.create(a),h=twve.text.lastIndexOf(b,c.open,h,!0);if(0>h.ndx)return null;do{if(h.ndx>=f.ndx&&h.ndx+h.matched.length<=a){var l=c.exactCloseTag(h.matched),k=twve.position.create(h.ndx+h.matched.length),k=twve.text.indexOf(b,l.close,k);if(k.ndx>a&&k.ndx<g.ndx)return k;f.ndx=k.ndx}h=h.next}while(h);return null};c.mergeTag=
function(b,a){if(!b)return a;if(!a)return b;if("string"==typeof b)if("string"==typeof a)b!=a&&(b=[b,a]);else{b=[b];for(var c=0,g=a.length;c<g;c++)-1==b.indexOf(a[c])&&(b[b.length]=a[c])}else if("string"==typeof a)-1==b.indexOf(a)&&(b[b.length]=a);else{c=0;for(g=a.length;c<g;c++)-1==b.indexOf(a[c])&&(b[b.length]=a[c])}return b};c.merge=function(b){c.open=c.mergeTag(c.open,b.open);c.close=c.mergeTag(c.close,b.close);return c};return b?(c.open=a,c.close=b,c):c.created(a)}};
twve.link={enableEdit:!0,twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("a");return a},markupTags:function(){return twve.tags.create("[[","]]")}};
twve.tiddler={registered_element:null,registered_wrapper:null,registerElement:function(a){twve.tiddler.registered_element?-1==twve.tiddler.registered_element.indexOf(a)&&(twve.tiddler.registered_element[twve.tiddler.registered_element.length]=a):(twve.tiddler.registered_element=[],twve.tiddler.registered_element[twve.tiddler.registered_element.length]=a)},registerWrapper:function(a){twve.tiddler.registered_wrapper?-1==twve.tiddler.registered_wrapper.indexOf(a)&&(twve.tiddler.registered_wrapper[twve.tiddler.registered_wrapper.length]=
a):(twve.tiddler.registered_wrapper=[],twve.tiddler.registered_wrapper[twve.tiddler.registered_wrapper.length]=a)},enableAllEditable:function(a){for(var b in twve.tiddler.registered_element)b.enableEdit&&(b.enableEdit=!1!==a)},readOnly:function(a){return/^twve--example/i.test(a)?!1:readOnly},registeredEditableObject:function(a,b,c,d){if(!a||!b||!config.options.chktwveCoreEnabled)return null;for(var e=twve.selector.create(),f=b.length-1;0<=f;f--){var g=b[f];if(g.enableEdit)if(g.is){if(g.is(a))return c?
{obj:g,selector:e}:g}else if(e.clear(),g.twveSelector(e,d),twve.node.matches(a,e.include)&&(!e.exclude||!twve.node.matches(a,e.exclude)))return c?{obj:g,selector:e}:g}return null},createEditableElement:function(a){var b=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_element,!0);return!b?null:(a=b.obj.create?b.obj.create(a):twve.element.create(a))&&twve.tiddler.readOnly(a.wrapper_title)?null:a},twveSelector:function(a,b){var c=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_element,
!0,b);c||(c=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_wrapper,!0,b));return c?c.selector:null},twveFoldableSelector:function(){var a=twve.sliderPanel.twveSelector();twve.foldedSection.twveSelector(a);return a},twveTranscludedSelectors:function(){var a=twve.selector.create();twve.tabContent.twveSelector(a);twve.sliderPanel.twveSelector(a);twve.tiddlerSpan.twveSelector(a);return a},cloneMarkupTags:function(a,b){for(var c=a.length-1;0<=c;c--){var d=a[c];if(d.enableEdit&&d.markupTags&&
(d=d.markupTags(),d.is(b)))return d}return null},markupTags:function(a,b){if(a.nodeType){var c=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_element,!1,b);c||(c=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_wrapper,!1,b));return c&&c.markupTags?c.markupTags():null}return twve.tiddler.cloneMarkupTags(twve.tiddler.registered_element,a)||twve.tiddler.cloneMarkupTags(twve.tiddler.registered_wrapper,a)},registeredSelectors:function(a,b){b||(b=twve.selector.create());
for(var c=a.length-1;0<=c;c--)a[c].twveSelector(b);return b},elementSelectors:function(a){return twve.tiddler.registeredSelectors(twve.tiddler.registered_element,a)},wrapperSelectors:function(a){return twve.tiddler.registeredSelectors(twve.tiddler.registered_wrapper,a)},directWrapper:function(a,b){var c=twve.node.closest(a.parentNode,twve.tiddler.wrapperSelectors().include);return c?twve.tiddler.createEditableWrapper(c,b):null},createEditableWrapper:function(a,b){var c=twve.tiddler.registeredEditableObject(a,
twve.tiddler.registered_wrapper);if(c){var d=c.create?c.create(a):twve.wrapper.create(a);if(!d)return null;d.wrapper_title=c.titleOfWrapper(a);return b||!twve.tiddler.readOnly(d.wrapper_title)?d:null}return null},createEditable:function(a){var b=twve.tiddler.createEditableWrapper(a);b||(b=twve.tiddler.createEditableElement(a));return b&&b.isSystemShadow()?null:b},cloneEditable:function(a){var b=twve.tiddler.registeredEditableObject(a.dom,twve.tiddler.registered_element);return b?b.create?b.create(a):
twve.element.create(a):(b=twve.tiddler.registeredEditableObject(a.dom,twve.tiddler.registered_wrapper))?b.create?b.create(a):twve.wrapper.create(a):null},titleOfWrapper:function(a){if(!a)return"";var b=twve.tiddler.registeredEditableObject(a,twve.tiddler.registered_wrapper);return b&&b.titleOfWrapper?b.titleOfWrapper(a):""},wrapperFromTitle:function(a){if(!a)return null;a=twve.text.removeHeaderTail(a);var b=twve.text.tiddlerTitle(a);a=twve.text.tiddlerSection(a);for(var c=document.querySelectorAll("div[id=tiddlerDisplay]"),
d=null,e=twve.tiddler.registered_wrapper,f=e.length-1;0<=f;f--){var g=e[f];g.wrapperFromTitle&&(g=g.wrapperFromTitle(b,c,a))&&(d=d?d.concat(g):g)}return d},get:function(a,b){if(!b||b!=story)b=store;return b.getTiddler(twve.text.tiddlerTitle(a))},displaySelector:function(){return"div[id=displayArea]"},getDisplay:function(){return document.querySelector("div[id=displayArea]")},optionsMenu:null,getOptionsMenu:function(){twve.tiddler.optionsMenu||(twve.tiddler.optionsMenu=twve.menu.create(twve.button.create(null,
String.fromCharCode(8801),"''twve'' menu")),twve.tiddler.optionsMenu.addMenu("''twve.core'' Options",config.macros.twveCoreOptions.handler));return twve.tiddler.optionsMenu},cur_focus:null,focusElem:function(a,b){if("undefined"!=typeof a){twve.tiddler.cur_focus&&twve.tiddler.cur_focus.blur&&twve.tiddler.cur_focus.blur();if(a)a.focus&&a.focus();else{var c=twve.tiddler.getOptionsMenu();c&&c.hide(!0);/^keep/i.test(b)||twve.tiddler.drawFocusBorders()}twve.tiddler.cur_focus=a}return twve.tiddler.cur_focus},
border_top:null,border_bottom:null,border_left:null,border_right:null,createFocusBorder:function(a,b){a||(a=twve.tiddler.getDisplay());var c=document.createElement("div");a.appendChild(c);c.style.position="absolute";twve.node.setDimension(c,null,0);switch(b){case "left":c.style.borderLeftWidth="1px";c.style.borderLeftStyle="dashed";break;case "right":c.style.borderRightWidth="1px";c.style.borderRightStyle="dashed";break;case "top":c.style.borderTopWidth="1px";c.style.borderTopStyle="dashed";break;
case "bottom":c.style.borderBottomWidth="1px",c.style.borderBottomStyle="dashed"}return c},focusBorderVisible:function(){return twve.node.isVisible(twve.tiddler.border_top[0])},prepareFocusBorders:function(a){twve.node.setPosition(twve.tiddler.border_left[0],a.left,a.top);twve.node.setDimension(twve.tiddler.border_left[0],null,a.height);twve.node.setPosition(twve.tiddler.border_top[0],a.left,a.top);twve.node.setDimension(twve.tiddler.border_top[0],a.width);twve.node.setPosition(twve.tiddler.border_bottom[0],
a.left,a.bottom);twve.node.setDimension(twve.tiddler.border_bottom[0],a.width);twve.node.setPosition(twve.tiddler.border_right[0],a.right,a.top);twve.node.setDimension(twve.tiddler.border_right[0],null,a.height);return 1},focus_box:null,focusBox:function(){return twve.tiddler.focus_box},clearFocusBox:function(){twve.tiddler.focus_box=null},drawFocusBorders:function(a){a?(twve.tiddler.focus_box=[{}],a.cloneTo(twve.tiddler.focus_box[0],0,!1),a.cloneTo(twve.tiddler.focus_box),a=twve.tiddler.prepareFocusBorders(a),
config.options.chktwveCoreShowFocus&&(twve.node.show(twve.tiddler.border_top,0,a),twve.node.show(twve.tiddler.border_bottom,0,a),twve.node.show(twve.tiddler.border_left,0,a),twve.node.show(twve.tiddler.border_right,0,a))):(twve.tiddler.focus_box=null,twve.node.hide(twve.tiddler.border_top),twve.node.hide(twve.tiddler.border_bottom),twve.node.hide(twve.tiddler.border_left),twve.node.hide(twve.tiddler.border_right))},editWrappers:function(){return config.options.chktwveCoreEditWrappers},focus:function(a,
b,c,d){var e=null;if(!a||!config.options.chktwveCoreEnabled)b="off";else{e=a.dom;if(twve.node.closest(e,".preview"))return;config.options.chktwveCoreNoClick&&(!twve.tiddler.cur_editable||!twve.tiddler.cur_editable.is(e))&&twve.tiddler.editInPlace(a,c)}if(!twve.tiddler.border_top){var f=twve.tiddler.getDisplay();twve.tiddler.border_top=[];twve.tiddler.border_top[0]=twve.tiddler.createFocusBorder(f,"top");twve.tiddler.border_bottom=[];twve.tiddler.border_bottom[0]=twve.tiddler.createFocusBorder(f,"bottom");
twve.tiddler.border_left=[];twve.tiddler.border_left[0]=twve.tiddler.createFocusBorder(f,"left");twve.tiddler.border_right=[];twve.tiddler.border_right[0]=twve.tiddler.createFocusBorder(f,"right")}twve.tiddler.drawFocusBorders();if(!e||"off"==b||a.isWrapper()&&!twve.tiddler.editWrappers())twve.tiddler.focusElem(null);else if(twve.tiddler.focusElem(a),d||(d=a.box("focus",c)),d&&d.height>=twve.node.cssSize("font-size",e))return a.drawFocusBorders?a.drawFocusBorders(d):twve.tiddler.drawFocusBorders(d),
!0},mousePosition:function(a){var b=twve.object.create();a&&(b.x=a.pageX,b.y=a.pageY);return twve.node.adjustPosition(b)},focusTarget:function(a){return a.target},mouseMove:function(a){a=a||window.event;var b=twve.tiddler.focusElem(),c=null,d=null,e=twve.tiddler.focusTarget(a);if(b)if(b.is(e))b.mousemove&&b.mousemove(a);else{(config.browser.isAndroid||config.browser.isiOS)&&twve.tiddler.updateText();var c=twve.tiddler.focusBox(),f=twve.node.box(e);if(c&&c.contains(f))twve.tiddler.focusElem(null,"keep"),
(d=twve.tiddler.createEditable(e))?(twve.tiddler.focus(),c=d.differentBox?null:f):twve.tiddler.focusElem(b);else if(b.mouseleave?b.mouseleave(a):1)twve.tiddler.focus(),(d=twve.tiddler.createEditable(e))&&(c=d.differentBox?null:f)}else(config.browser.isAndroid||config.browser.isiOS)&&twve.tiddler.updateText(),d=twve.tiddler.createEditable(e);d&&(!d.mouseenter||d.mouseenter(a))&&twve.tiddler.focus(d,"on",a,c)},eventTarget:function(a){return 0==a.button||config.browser.isIE&&1==a.button?a.target:null},
m_count:0,down_elem:null,mouseDown:function(a){a=a||window.event;var b=twve.tiddler.eventTarget(a);if(b){a=twve.tiddler.mousePosition(a);var c=twve.tiddler.focusElem();if(c&&c.is(b)&&(c=twve.tiddler.focusBox())&&(a.x>=c.right||a.y>=c.bottom))return twve.tiddler.down_elem=null;c=twve.tiddler.getOptionsMenu();c.isVisible()&&c.contains(a)||"A"==b.nodeName||twve.node.closest(b,"A")?(b=null,twve.tiddler.m_count=0):(config.browser.isAndroid||config.browser.isiOS?0<twve.tiddler.m_count&&c.hide(!0):c.hide(!0),
b!=twve.tiddler.down_elem&&(twve.tiddler.m_count=0))}return twve.tiddler.down_elem=b},mouseUp:function(a){if(twve.tiddler.down_elem){a=a||window.event;var b=twve.tiddler.eventTarget(a);if(b&&b==twve.tiddler.down_elem&&!twve.button.isSystemButton(b)){var c=twve.tiddler.getEditBox();if(c&&twve.node.is(b,c))twve.tiddler.previewEditBox(b);else if(!twve.node.closest(b,".preview")&&!twve.node.matches(b,"textarea,input"))if(twve.node.matches(b,"html,#displayArea,#contentWrapper,.txtMainTab,.header,.headerShadow,.headerForeground,.siteTitle,.siteSubtitle,#menuBar"))twve.tiddler.updateText(),
twve.tiddler.focus();else{var d=twve.tiddler.focusElem();if(d){if(config.browser.isAndroid||config.browser.isiOS){if(2>++twve.tiddler.m_count)return;twve.tiddler.m_count=0}c&&twve.tiddler.updateTextAndIndex(d);if(d.isEditable(b))return!twve.tiddler.editInPlace(d,a)}}}}},resize:function(a){if(!twve.tiddler.cur_editable&&!config.browser.isAndroid&&!(config.browser.isiOS||config.browser.isIE&&!config.browser.isIE9)){a=twve.viewer.create();for(var b=twve.viewer.twveSelector(),b=document.querySelectorAll(b.include),
c=0,d=b.length;c<d;c++)a.setElement(b[c]),a.refreshSelf(),a.clear();twve.tiddler.focusElem(null);b=document.querySelectorAll("#sidebar,#mainMenu");window.innerWidth<screen.width/2?twve.node.hide(b):twve.node.show(b)}},saveText:function(a,b,c){var d=a.tiddler;b=b?b:d.text;if(c){if(store.tiddlerExists(c)){if(!confirm(config.messages.overwriteWarning.format([c])))return null;story.closeTiddler(c,!1)}a=story.getTiddler(d.title);a.id=story.tiddlerId(c);a.setAttribute("tiddler",c);store.saveTiddler(d.title,
c,b);return b}c=null;config.macros.undo&&(c=store.undo_saveTiddler,store.undo_saveTiddler=function(){},store.saveTiddler(d.title,d.title,b));d.set(d.title,b,d.modifier,new Date);store.setDirty(!0);config.macros.undo&&(store.undo_saveTiddler=c);"file:"==window.location.protocol?config.options.chktwveCoreManualSave||autoSaveChanges(null,[a.tiddler]):!config.options.chktwveCoreManualUpload&&config.macros.upload&&config.macros.upload.action();return b},preRefreshTiddler:null,refreshTiddler:function(){var a=
twve.tiddler.preRefreshTiddler.apply(this,arguments);if(a&&config.options.chktwveCoreEnabled){var b=a.querySelector(".viewer");b||(b=a);twve.viewer.create(b).waitAndPrepare();b=twve.node.closest(a,"div[id=tiddlerDisplay]");!config.browser.isAndroid&&!config.browser.isiOS&&(b.removeEventListener("mousemove",twve.tiddler.mouseMove),b.addEventListener("mousemove",twve.tiddler.mouseMove));config.browser.isAndroid||config.browser.isiOS?(document.removeEventListener("touchstart",twve.tiddler.mouseDown),
document.addEventListener("touchstart",twve.tiddler.mouseDown),document.removeEventListener("touchend",twve.tiddler.mouseUp),document.addEventListener("touchend",twve.tiddler.mouseUp)):(document.removeEventListener("mousedown",twve.tiddler.mouseDown),document.addEventListener("mousedown",twve.tiddler.mouseDown),document.removeEventListener("mouseup",twve.tiddler.mouseUp),document.addEventListener("mouseup",twve.tiddler.mouseUp));twve.tiddler.getOptionsMenu().hide(!0)}return a},prePopupShow:null,popupShow:function(){twve.tiddler.prePopupShow.apply(this,
arguments);var a=Popup.stack[Popup.stack.length-1];twve.wrapper.create(a.popup).waitAndPrepare();return a},preTabsSwitchTab:null,tabsSwitchTab:function(a,b){twve.tiddler.preTabsSwitchTab.apply(this,arguments);if(twve.node.closest(a,twve.tiddler.displaySelector())){twve.tabContent.create(a.nextSibling).waitAndPrepare();var c=twve.tiddler.focusElem();c&&twve.tiddler.drawFocusBorders(c.box())}},preTiddlerTransclude:null,tiddlerTransclude:function(a){twve.tiddler.preTiddlerTransclude.apply(this,arguments);
if(twve.node.closest(a,twve.tiddler.displaySelector())){var b=twve.tiddlerSpan.create(a);b.waitAndPrepare&&b.waitAndPrepare()}},preSliderHandler:null,sliderHandler:function(a){twve.tiddler.preSliderHandler.apply(this,arguments);if(twve.node.closest(a,twve.tiddler.displaySelector())){var b=twve.sliderPanel.create(a.querySelector("div[tiddler]"));b.waitAndPrepare&&b.waitAndPrepare()}},preOnClickSlider:null,onClickSlider:function(){twve.tiddler.preOnClickSlider.apply(this,arguments)},cur_editable:null,
edit_box:null,getEditBox:function(){return twve.tiddler.edit_box},setEditBox:function(a){return twve.tiddler.edit_box=a},preview:null,getPreviewer:function(a){if(!twve.tiddler.preview){a||(a=twve.tiddler.getDisplay());var b=document.createElement("div");twve.tiddler.preview=b;a.appendChild(b);b.style.position="absolute";b.style.overflow="auto";b.style.zIndex=1;b.style.border="1px solid black";b.style.padding=0;b.style.margin=0;b.style.backgroundColor="#fff8dc";b.classList.add("preview");a=document.createElement("div");
b.appendChild(a);a.classList.add("board","viewer","tiddler","selected");twve.node.hide(b)}return twve.tiddler.preview},editInPlace:function(a,b){return b&&(b.ctrlKey||b.shiftKey||b.altKey)?!1:a.tiddler?a.editText(b):!1},updateText:function(a){var b=twve.tiddler.cur_editable;a||(a=twve.tiddler.getEditBox());if(a&&b){var c=!1,d=!1,e=null,f;if(a)for(var e=[],g=0,h=a.length;g<h;g++)if(a[g].nodeType)f=a[g].value,e[g]=f,"true"==a[g].getAttribute("cancel")&&(c=!0),a[g].defaultValue!=f&&(d=!0);else{e[g]=
[];for(var l=0,k=a[g].length;l<k;l++)f=a[g][l].value,e[g][l]=f,"true"==a[g][l].getAttribute("cancel")&&(c=!0),a[g][l].defaultValue!=f&&(d=!0)}!c&&d&&b.updateText(e)}twve.tiddler.closeEditbox();twve.tiddler.cur_editable=null},updateTextAndIndex:function(a){var b=twve.tiddler.cur_editable,c=b.end.ndx;twve.tiddler.updateText();if(a){var d=b.end.ndx-c;d&&twve.text.tiddlerTitle(b.wrapper_title)==twve.text.tiddlerTitle(a.wrapper_title)&&(b.dom==a.dom?a.end.ndx=b.end.ndx:a.start.ndx>c&&(a.start.ndx+=d,a.end.ndx+=
d))}},caretPosition:function(a,b,c){if("undefined"==typeof b){try{if(document.selection){a.focus();var d=document.selection.createRange(),e=d.duplicate();e.moveToElementText(a);e.setEndPoint("EndToStart",d);return e.text.length-d.text.length}if(a.selectionStart||"0"==a.selectionStart)return 1*a.selectionStart}catch(f){}return-1}"number"!=typeof b&&(b=0);"number"!=typeof c?c=b:b>c&&(d=b,b=c,c=d);a.setSelectionRange?(a.focus(),a.setSelectionRange(b,c)):a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),
a.moveEnd("character",c),a.moveStart("character",b),a.select())},getSelectionText:function(a){var b=twve.object.create();b.start=0;b.end=0;if("number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd)b.start=a.selectionStart,b.end=a.selectionEnd;else if(document.selection){var c=document.selection.createRange().getBookmark();a=a.createTextRange();var d=a.duplicate();a.moveToBookmark(c);d.setEndPoint("EndToStart",a);b.start=d.text.length;b.end=b.start+a.text.length}return b},closeEditbox:function(){twve.tiddler.preview&&
twve.node.hide(twve.tiddler.preview);var a=twve.tiddler.edit_box;if(a){for(var b=0,c=a.length;b<c;b++)if(a[b].nodeType)a[b].parentNode.removeChild(a[b]);else for(var d=0,e=a[b].length;d<e;d++)a[b][d].parentNode.removeChild(a[b][d]);twve.tiddler.edit_box=null}},previewEditBox:function(a,b){var c=twve.tiddler.getPreviewer();if(!config.options.chktwveCorePreview||!twve.tiddler.cur_editable)return twve.node.hide(c),null;twve.node.setDimension(c,a.offsetWidth);if("number"!=typeof b||-1==b)b=twve.tiddler.caretPosition(a);
var d=a.value,d=0==b?config.options.txttwveCorePreviewCaret+d:d.substring(0,b)+config.options.txttwveCorePreviewCaret+d.substring(b);twve.node.show(c);var e=c.querySelector("div.board");twve.node.copyFontColor(e,c);twve.node.wikify(d,e);twve.tiddler.cur_editable.isWrapper()&&(d=twve.tiddler.cur_editable.clone(),d.dom=e,d.waitAndPrepare());var d=(new String(config.options.txttwveCorePreviewHeight)).toLowerCase().trim(),f=twve.node.cssSize(window.getComputedStyle(e).getPropertyValue("line-height")),
d=/\D$/.test(d)?twve.node.cssSize(d):f*d,e=e.offsetHeight+f;e>d&&(e=d);d=twve.node.box(a);e>d.top?(e=d.top,d.top=0):d.top-=e;twve.node.setPosition(c,d.left,d.top-2);twve.node.setDimension(c,null,e+1);return c},getPreviewedNodes:function(a){var b=twve.tiddler.getPreviewer();if(twve.node.isVisible(b))return twve.node.wikify(a);twve.node.show(b);a=twve.node.wikify(a);twve.node.hide(b);return a},caret_pos:null,initCaretPos:function(a){twve.tiddler.caret_pos||(twve.tiddler.caret_pos=twve.object.create());
void 0===a&&(a=-100);twve.tiddler.caret_pos.cur=a;twve.tiddler.caret_pos.last=a},updateCaretPosition:function(a,b){var c=twve.tiddler.caretPosition(a);(b||c!=twve.tiddler.caret_pos.cur)&&twve.tiddler.previewEditBox(a,c);twve.tiddler.caret_pos.last=twve.tiddler.caret_pos.cur;twve.tiddler.caret_pos.cur=c},keydownAfter:function(a,b){if(27==a.which)return b.setAttribute("cancel","true"),twve.tiddler.updateText(),!1;if(!twve.tiddler.cur_editable)return!1;var c=!1;switch(a.which){case 46:c=!0;case 8:if(a.alterKey)return!1;
break;case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:if(a.alterKey||a.shiftKey)return!1;break;default:Math.round(twve.node.height(b));twve.node.setDimension(b,null,0);var d=1*b.getAttribute("scrH0"),e=b.scrollHeight,e=Math.max(e,d);twve.node.setDimension(b,null,e)}twve.tiddler.updateCaretPosition(b,c);return!0},keydown:function(a){a=a||window.event;var b=this,c=twve.tiddler.cur_editable;switch(a.which){case 13:if(c.multiLine(b.value)){if(a.ctrlKey)return twve.tiddler.updateText(),
!1;0==twve.tiddler.caret_pos.cur&&twve.tiddler.caret_pos.cur++}else return twve.tiddler.updateText(),!1;default:setTimeout(function(){twve.tiddler.keydownAfter(a,b)},0)}},text_before_paste:null,selection_at_paste:null,textPasted:function(a){(a=a.value)&&(a=a.substring(twve.tiddler.selection_at_paste.start,twve.tiddler.selection_at_paste.start+(a.length-twve.tiddler.text_before_paste.length+twve.tiddler.selection_at_paste.end-twve.tiddler.selection_at_paste.start)));return a},paste:function(){if(!twve.tiddler.text_before_paste){var a=
this;twve.tiddler.text_before_paste=a.value;twve.tiddler.selection_at_paste=twve.tiddler.getSelectionText(a);setTimeout(function(){twve.tiddler.cur_editable.pasteIn&&twve.tiddler.cur_editable.pasteIn(a);twve.tiddler.text_before_paste=null},0)}},copyOrCut:function(a){twve.tiddler.cur_editable.copyOrCut&&twve.tiddler.cur_editable.copyOrCut(this,a)},preEditHandler:null,editHandler:function(a,b,c){twve.tiddler.updateText();twve.tiddler.preEditHandler.apply(this,arguments);return!1},precloseTiddler:null,
closeTiddler:function(){twve.tiddler.updateText();twve.tiddler.focus();return twve.tiddler.precloseTiddler.apply(this,arguments)},preSaveHandler:null,saving:!1,saveHandler:function(){twve.tiddler.saving=!0;var a=twve.tiddler.preSaveHandler.apply(this,arguments);twve.tiddler.saving=!1;return a},preCancelHandler:null,cancelHandler:function(a,b,c){return store.isDirty()&&!confirm(this.warning.format([c]))?!1:twve.tiddler.preCancelHandler.apply(this,arguments)},preSaveChanges:null,saveChanges:function(){twve.tiddler.preSaveChanges.apply(this,
arguments);config.macros.upload&&config.macros.upload.action()}};
twve.position={init:function(a,b,c){switch(typeof b){case "number":a.ndx=0>b?0:b;a.matched=c;break;case "object":a.ndx=0>b.ndx?0:b.ndx;a.matched=b.matched;break;default:a.clear()}return a},ensureValid:function(a,b){b&&twve.position.init(a,b);0>a.ndx&&(a.ndx=0);return a},create:function(a,b){var c=twve.object.create();c.clear=function(){c.ndx=-1;c.matched="";return c};c.init=function(b,a){return twve.position.init(c,b,a)};c.ensureValid=function(b){return twve.position.ensureValid(c,b)};return c.init(a,
b)}};
twve.selector={create:function(a,b){var c=twve.object.create();c.clear=function(){c.include="";c.exclude="";return c};c.copyFrom=function(b,a){if("string"==typeof a)return c.include=b,c.exclude=a,c;if(b.include)return c.include=b.include,c.exclude=b.exclude,c;if(b.dom)return c.include=b.selector.include,c.exclude=b.selector.exclude,c;if(b=twve.tiddler.twveSelector(b))c.include=b.include,c.exclude=b.exclude;return c};c.includeSelector=function(b){b&&(c.include+=(c.include?",":"")+b);return c.include};c.excludeSelector=
function(b){b&&(c.exclude+=(c.exclude?",":"")+b);return c.exclude};c.clear();return a||b?c.copyFrom(a,b):c}};
twve.node={info:function(a){if(!a)return a;if(a.nodeType)return a.nodeName;var b=a.length,c="("+b+")[";--b;for(var d=0;d<b;d++)c+=a[d].nodeName+", ";return c+a[b].nodeName+"]"},matches:function(a,b){if(!a||!b)return!1;if(!a.nodeType){for(var c=0,d=a.length;c<d;c++)if(twve.node.matches(a[c],b))return!0;return!1}if(c=a.matches||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector||a.oMatchesSelector)return c.call(a,b);if(!a.parentNode)return!1;d=a.parentNode.querySelectorAll(b);if(!d.length)return!1;
for(var c=0,e=d.length;c<e;c++)if(d[c]==a)return!0;return!1},closest:function(a,b){for(;a;){if(twve.node.matches(a,b))return a;a=a.parentNode}return null},parents:function(a,b,c){var d=[];for(a=a.parentNode;a;){if(!b||twve.node.matches(a,b))if(!c||c.call(a))d[d.length]=a;a=a.parentNode}return d.length?d:null},is:function(a,b){if(!a||!b)return!1;if("string"==typeof b)return twve.node.matches(a,b);if(a.nodeType){if(b.nodeType)return a==b;for(var c=0,d=b.length;c<d;c++)if(twve.node.is(a,b[c]))return!0}else if(b.nodeType){c=
0;for(d=a.length;c<d;c++)if(twve.node.is(a[c],b))return!0}else{c=0;for(d=a.length;c<d;c++)for(var e=0,d=b.length;e<d;e++)if(twve.node.is(a[c],b[e]))return!0}return!1},not:function(a,b){if("string"==typeof b){for(var c=0;c<a.length;)twve.node.matches(a[c],b)?a.splice(c,1):c++;return a}if(b.nodeType){var d=a.indexOf(b);-1<d&&a.splice(d,1)}else for(var c=0,e=b.length;c<e;c++)d=a.indexOf(b[c]),-1<d&&a.splice(d,1);return a},replace:function(a,b,c){c||(c=b.parentNode);if(a.nodeType)c.insertBefore(a,b);
else for(;a.length;)c.insertBefore(a[0],b);c.removeChild(b)},scw:0,scrollBarWidth:function(a){if(!twve.node.scw){if(!a)return 0;var b=a.style.overflow;a.style.overflow="scroll";twve.node.scw=a.offsetWidth-a.clientWidth;a.style.overflow=b}return twve.node.scw},adjustPosition:function(a){var b=twve.tiddler.getDisplay();"static"!=window.getComputedStyle(b).getPropertyValue("position")&&(void 0!==a.left?(a.left-=b.offsetLeft,a.top-=b.offsetTop):(a.x-=b.offsetLeft,a.y-=b.offsetTop));return a},shiftPosition:function(a,
b,c){if(void 0!==b){var d=void 0===c||null===c,e="number"==typeof b?"px":"",f="number"==typeof c?"px":"";if(a.nodeType)null!==b&&(a.style.left=a.offsetLeft+b+e),d||(a.style.top=a.offsetTop+c+f);else for(var g=0,h=a.length;g<h;g++)null!==b&&(a[g].style.left=a[g].offsetLeft+b+e),d||(a[g].style.top=a[g].offsetTop+c+f)}},setPosition:function(a,b,c){if(void 0!==b){var d=void 0===c||null===c,e="number"==typeof b?"px":"",f="number"==typeof c?"px":"";if(a.nodeType)null!==b&&(a.style.left=b+e),d||(a.style.top=
c+f);else for(var g=0,h=a.length;g<h;g++)null!==b&&(a[g].style.left=b+e),d||(a[g].style.top=c+f)}},setDimension:function(a,b,c){if(void 0!==b){var d=void 0===c||null===c,e="number"==typeof b?"px":"",f="number"==typeof c?"px":"";if(a.nodeType)null!==b&&(a.style.width=b+e),d||(a.style.height=c+f);else for(var g=0,h=a.length;g<h;g++)null!==b&&(a[g].style.width=b+e),d||(a[g].style.height=c+f)}},positionShift:function(){var a=document.body,b=document.documentElement;return twve.node.adjustPosition({left:(window.pageXOffset||
b.scrollLeft||a.scrollLeft)-(b.clientLeft||a.clientLeft||0),top:(window.pageYOffset||b.scrollTop||a.scrollTop)-(b.clientTop||a.clientTop||0)})},boxInit:function(a,b,c,d){c.top=a.top;c.right=a.right;c.bottom=a.bottom;c.left=a.left;c.shift=function(b){c.top+=b.top;c.right+=b.left;c.bottom+=b.top;c.left+=b.left;return c};b&&c.shift(b);if(!1===d)return c;c.toString=function(){return twve.object.toString(c)};c.containsX=function(b){return b>=c.left&&b<=c.right};c.containsY=function(b){return b>=c.top&&
b<=c.bottom};c.contains=function(b){return b.left?c.containsX(b.left)&&c.containsX(b.right)&&c.containsY(b.top)&&c.containsY(b.bottom):c.containsX(b.x)&&c.containsY(b.y)};c.cloneTo=function(b,a,d){a="number"==typeof a?c[a]:c;twve.node.boxInit(a,null,b,d);b.width=a.width;b.height=a.height;return b};return c},box:function(a,b,c){if(!a)return null;var d=null;if(3==a.nodeType){var e=document.createRange();e.selectNodeContents(a);d=e.getClientRects();e.detach()}else if(twve.node.matches(a,twve.tiddler.twveTranscludedSelectors().include))d=
[{}],d[0].left=a.offsetLeft,d[0].top=a.offsetTop,d[0].width=a.offsetWidth,d[0].height=a.offsetHeight,d[0].right=a.offsetLeft+d[0].width,d[0].bottom=a.offsetTop+d[0].height;else if(a.getClientRects){if(!twve.node.isVisible(a))return null;d=a.getClientRects()}else d=[{}],d[0].left=a.screenX,d[0].top=a.screenY,d[0].width=a.innerWidth,d[0].height=a.innerHeight,d[0].right=a.screenX+d[0].width,d[0].bottom=a.screenY+d[0].height;d.initFrom=function(b,a,c,e){return twve.node.boxInit(b,a,c||d,e)};e=twve.node.positionShift();
if(a.getBoundingClientRect)d.initFrom(a.getBoundingClientRect(),e),b?d.width=d.right-d.left:(d.width=a.clientWidth||a.offsetWidth,d.right=d.left+d.width),c?d.height=d.bottom-d.top:(d.height=a.clientHeight||a.offsetHeight,d.bottom=d.top+d.height);else{if(!d[0])return null;d.initFrom(d[0]);for(a=1;a<d.length;a++)d[a].left<d.left&&(d.left=d[a].left),d[a].right>d.right&&(d.right=d[a].right),d[a].bottom>d.bottom&&(d.bottom=d[a].bottom);d.width=d.right-d.left;d.height=d.bottom-d.top;d.shift(e)}return d},
cssSize:function(a,b){if(!a)return!b?0:parseFloat(window.getComputedStyle(b).getPropertyValue("font-size"));a=(new String(a)).toLowerCase().trim();var c=a.substring(a.length-2);switch(c){case "px":return Math.round(parseFloat(a));case "pt":return Math.round(16*parseFloat(a)/12);default:var d=parseFloat(a);if(isNaN(d)){c=null;try{c=window.getComputedStyle(b)}catch(e){b=twve.tiddler.getDisplay(),c=window.getComputedStyle(b)}finally{return c?twve.node.cssSize(c.getPropertyValue(a),b):0}}return"em"==
c?Math.round(16*d*parseFloat(window.getComputedStyle(b).getPropertyValue("font-size"))/12):"%"==c.charAt(1)?Math.round(d/100*twve.node.width(b,"inner")):d}},bgc:function(a,b){b||(b=window.getComputedStyle(a));for(var c;"transparent"==(c=b.getPropertyValue("background-color"))||"rgba(0, 0, 0, 0)"==c||"inherit"==c;)if(a=a.parentNode,!a){c="#fff";break}return c},copyFontColor:function(a,b,c){if(a&&b){var d=window.getComputedStyle(b);c||(c=d.getPropertyValue("vertical-align"));var e=d.getPropertyValue("background-color");
switch(e){case "transparent":case "rgba(0, 0, 0, 0)":case "inherit":e=twve.node.bgc(b,d);default:a.style.backgroundColor=e}a.style.fontSize=d.getPropertyValue("font-size");a.style.fontFamily=d.getPropertyValue("font-family");a.style.fontStyle=d.getPropertyValue("font-style");a.style.color=d.getPropertyValue("color");a.style.textAlign=d.getPropertyValue("text-align");a.style.verticalAlign=c}},wikify:function(a,b){if(b)b.innerHTML="",wikify(a,b);else{var c=twve.tiddler.getPreviewer().querySelector("div.board");
c.innerHTML="";wikify(a,c);b=c.childNodes}return b},isVisible:function(a){return!a?!1:3==a.nodeType?!0:a.style?"none"!=a.style.display:!0},hide:function(a){if(a)if(twve.object.isCollection(a))for(var b=0,c=a.length;b<c;b++)a[b].style.display="none";else a.style.display="none"},show:function(a,b,c){if(a)if(twve.object.isCollection(a)){if("number"!=typeof c||c>a.length)c=a.length;if("number"!=typeof b||0>b)b=0;for(;b<c;b++)a[b].style.display=""}else a.style.display=""},getMargin:function(a,b){var c=
window.getComputedStyle(a),d;switch(b.charAt(0)){case "h":case "H":return d=(d=a.style.marginLeft||c.getPropertyValue("margin-left"))?parseInt(d):0,c=(c=a.style.marginRight||c.getPropertyValue("margin-right"))?parseInt(c):0,d+c;case "v":case "V":return d=(d=a.style.marginTop||c.getPropertyValue("margin-top"))?parseInt(d):0,c=(c=a.style.marginBottom||c.getPropertyValue("margin-bottom"))?parseInt(c):0,d+c;case "l":case "L":return(d=a.style.marginLeft||c.getPropertyValue("margin-left"))?parseInt(d):
0;case "t":case "T":return(d=a.style.marginTop||c.getPropertyValue("margin-top"))?parseInt(d):0;case "r":case "R":return(c=a.style.marginRight||c.getPropertyValue("margin-right"))?parseInt(c):0;case "b":case "B":return(c=a.style.marginBottom||c.getPropertyValue("margin-bottom"))?parseInt(c):0}return 0},getPadding:function(a,b){var c=window.getComputedStyle(a),d;switch(b.charAt(0)){case "h":case "H":return d=(d=a.style.paddingLeft||c.getPropertyValue("padding-left"))?parseInt(d):0,c=(c=a.style.paddingRight||
c.getPropertyValue("padding-right"))?parseInt(c):0,d+c;case "v":case "V":return d=(d=a.style.paddingTop||c.getPropertyValue("padding-top"))?parseInt(d):0,c=(c=a.style.paddingBottom||c.getPropertyValue("padding-bottom"))?parseInt(c):0,d+c;case "l":case "L":return(d=a.style.paddingLeft||c.getPropertyValue("padding-left"))?parseInt(d):0;case "t":case "T":return(d=a.style.paddingTop||c.getPropertyValue("padding-top"))?parseInt(d):0;case "r":case "R":return(c=a.style.paddingRight||c.getPropertyValue("padding-right"))?
parseInt(c):0;case "b":case "B":return(c=a.style.paddingBottom||c.getPropertyValue("padding-bottom"))?parseInt(c):0}return 0},width:function(a,b,c){var d=0,d=/^out/i.test(b),e=!twve.node.isVisible(a);e&&twve.node.show(a);d?(d=a.offsetWidth,c&&(d+=twve.node.getMargin(a,"horizontal"))):(d=a.clientWidth,/^inn/i.test(b)&&(d-=twve.node.getPadding(a,"horizontal")));e&&twve.node.hide(a);return d},height:function(a,b,c){var d=0,d=/^out/i.test(b),e=!twve.node.isVisible(a);e&&twve.node.show(a);d?(d=a.offsetHeight,
c&&(d+=twve.node.getMargin(a,"vertical"))):(d=a.clientHeight,/^inn/i.test(b)&&(d-=twve.node.getPadding(a,"vertical")));e&&twve.node.hide(a);return d},contains:function(a,b,c){if(/^geo/i.test(c)){a=twve.node.box(a,!0,!0);if(!a)return!1;if(b.x)return a?a.contains(b):!1;b.dom&&(b=b.dom);return a.contains(twve.node.box(b))}for(;b=b.parentNode;)if(a==b)return!0;return!1},index:function(a){for(var b=a.parentNode.childNodes,c=0,d=b.length;c<d;c++)if(b[c]==a)return c;return-1},create:function(a){var b=twve.object.create();
b.clear=function(){b.dom=null;return b};b.copyFrom=function(a){b.dom=a.dom;return b};b.is=function(a){return a&&a.dom?b.dom==a.dom:twve.node.is(b.dom,a)};b.not=function(a){return twve.node.not(b.dom,a)};b.hide=function(){twve.node.hide(b.dom);return b};b.show=function(a){twve.node.show(b.dom);a&&twve.node.setPosition(b.dom,a.left,a.top);return b};b.isVisible=function(){return twve.node.isVisible(b.dom)};b.width=function(a,d){return twve.node.width(b.dom,a,d)};b.height=function(){return twve.node.height(b.dom)};
b.getElement=function(){return b.dom};b.box=function(){return twve.node.box(b.getElement())};b.contains=function(a,d){return twve.node.contains(b.dom,a,d)};b.add=function(a){b.dom.nodeType&&(b.dom=[b.dom]);b.dom[b.dom.length]=a.dom||a;return b};b.clear();switch(typeof a){case "string":b.dom=document.createElement(a);break;case "object":a.dom?b.copyFrom(a):a.nodeName&&(b.dom=a)}return b}};
twve.nodeList={toArray:function(a){var b=[];if(a.nodeType)b[0]=a;else for(var c=0,d=b.length=a.length;c<d;c++)b[c]=a[c];return b},querySelectorAll:function(a,b){if(a.nodeType)return twve.nodeList.toArray(a.querySelectorAll(b));for(var c=null,d=0,e=a.length;d<e;d++)var f=twve.nodeList.toArray(a[d].querySelectorAll(b)),c=c?c.concat(f):f;return c}};
twve.button={isSystemButton:function(a){return twve.node.matches(a,"svg.SVGAnimatedString, path.SVGAnimatedString")},isActive:function(a){return"1"==(a.style?a.style.opacity:window.getComputedStyle(a).getPropertyValue("opacity"))},activate:function(a,b){return a.style.opacity=b?1:0.4},create:function(a,b,c,d,e){var f=twve.node.create(createTiddlyButton(a,b,c,d));f.isActive=function(){return twve.button.isActive(f)};f.activate=function(b){return twve.button.activate(f.dom,b)};f.dom.setAttribute("id",
"twveTbtn"+(e?e:b));f.dom.style.position="absolute";f.dom.style.zIndex=1;f.dom.style.textAlign="center";f.dom.addEventListener("mouseenter",function(b){f.mouseenter&&f.mouseenter.call(this,b||window.event)});f.dom.addEventListener("mouseleave",function(b){f.mouseleave&&f.mouseleave.call(this,b||window.event)});f.dom.addEventListener("click",function(b){f.click&&f.click.call(this,b||window.event)});return f},createDelete:function(a,b,c){return twve.button.create(null,"\u2297",a,b,c)}};
twve.menu={create:function(a,b){var c=twve.node.create("div");c.findItem=function(b){if(c.items)for(var a=0;a<c.items.length;a++){var d=c.items[a];if(d.label==b)return d}return null};c.addItem=function(b,a){c.items||(c.items=[]);var d=twve.button.create(createTiddlyElement(c.dom,"li"),null,a);d.dom.style.whiteSpace="nowrap";d.label=b;twve.node.wikify(b,d.dom);d.mouseenter=function(){var b=twve.object.create();b.left=d.dom.offsetLeft+c.dom.offsetLeft;b.top=d.dom.offsetTop+c.dom.offsetTop;d.submenu&&
d.submenu.show(b,"left")};d.mouseleave=function(b){b=twve.tiddler.mousePosition(b);d.submenu&&!d.submenu.contains(b)&&d.submenu.hide()};c.items[c.items.length]=d;c.dom.removeAttribute("adjusted");return d};c.addMenu=function(b,a){var d=c.findItem(b);d||(d=c.addItem(b));d.submenu||(d.submenu=twve.menu.create(d,!0),a&&a.call(this,d.submenu.dom));return d.submenu};var d=c.contains;c.contains=function(b){if(d.call(this,b,"geo"))return!0;if(c.items)for(var a=c.items.length-1;0<=a;a--)if(c.items[a].submenu&&
c.items[a].submenu.contains(b,"geo"))return!0;return!1};c.hideRoot=function(){c.root.hide();return c};c.hide=function(b){b&&c.hideRoot();twve.node.hide(c.dom);return c};c.adjustPosition=function(b,a,d,e,k){k||(k=c);d||(d=k.width("outer",!0));/left/i.test(a)&&(b.left-=d);e||(e=k.height("outer",!0));/top/i.test(a)?b.top-=e:/bottom/i.test(a)?b.top+=e:b.top++;return b};c.showRoot=function(b,a){var d=twve.object.create();d.left=b.left;d.top=b.top;c.adjustPosition(d,a,null,null,c.root);c.root.show(d);return d};
c.adjustDim=function(){if(c.items){for(var b=0,a=0,d=0;d<c.items.length;d++){var e=twve.node.width(c.items[d].dom,"outer",!0);e>b&&(b=e);twve.node.setPosition(c.items[d].dom,null,a);a+=twve.node.height(c.items[d].dom,"outer",!0)}twve.node.setDimension(c.dom,b,a+(config.browser.isOpera||config.browser.isChrome?twve.node.scrollBarWidth(c.dom)-4:0))}c.dom.setAttribute("adjusted","true");return c};c.show=function(b,a){twve.node.show(c.dom);c.dom.getAttribute("adjusted")||c.adjustDim();var d=c.width("outer",
!0);if(b){var e=twve.object.create();e.left=b.left+4;e.top=b.top;if(d>b.left){var k=c.root.width("outer",!0),m=twve.node.box(window).width;d+k+e.left<m?(a="right",e.left+=k-4):m-d>b.left?(twve.node.setDimension(c.dom,d=m-d),a="right",e.left+=k-4):twve.node.setDimension(c.dom,d=b.left)}k=20*twve.node.cssSize(window.getComputedStyle(c.dom).getPropertyValue("font-size"));c.height("outer",!0)>k&&twve.node.setDimension(c.dom,null,k);c.adjustPosition(e,a,d,k);twve.node.setPosition(c.dom,e.left,e.top)}return c};
var e=twve.tiddler.getDisplay();a.mouseenter||(a.mouseenter=function(){var b=twve.object.create();b.left=this.offsetLeft;b.top=this.offsetTop;c.show(b,"left");return c},a.click=function(){c.show();return c},e.appendChild(a.dom));c.root=a;e.appendChild(c.dom);c.dom.style.overflow="auto";c.dom.style.position="absolute";c.dom.classList.add("popup");c.hide();b?c.dom.addEventListener("mouseleave",function(){twve.node.hide(this)}):c.dom.addEventListener("mouseleave",function(b){c.mouseleave&&c.mouseleave.call(this,
b||window.event)});return c}};
twve.editable={create:function(a){var b=twve.node.create();b.clear=function(){b.wrapper_title="";b.tiddler=null;b.wrapper=null;b.start=twve.position.create();b.end=twve.position.create();return b};preCopyFrom=b.copyFrom;b.copyFrom=function(a){preCopyFrom.apply(this,arguments);b.wrapper_title=a.wrapper_title;b.tiddler=a.tiddler;b.wrapper=a.wrapper;b.start.copyFrom(a.start);b.end.copyFrom(a.end);return b};b.created=function(a){b.clear();return a?a.dom?b.copyFrom(a):b.setElement(a):b};b.isEditable=function(a){return b.is(a)||
b.contains(a)};b.beingEdited=function(){return b.is(twve.tiddler.cur_editable)};b.clone=function(){return twve.tiddler.cloneEditable(b)};b.multiLine=function(b){return/\n/.test(b)};b.twveSelector=function(a,d){return twve.tiddler.twveSelector(b.dom,a,d)};b.isWrapper=function(){return!1};b.foldedWrapper=function(){var a=b.directWrapper();return a.isVisible()?null:a};b.directWrapper=function(){return twve.tiddler.directWrapper(b.dom,!0)};b.isSystemShadow=function(){return b.wrapper_title?store.isShadowTiddler(b.wrapper_title):
!0};b.findWrappers=function(){b.wrapper||(b.wrapper=twve.tiddler.wrapperFromTitle(b.wrapper_title));return b.wrapper};b.setElement=function(a){if(a==b.dom)return null;b.dom=a;if(!b.directWrapper())return b;if(!b.wrapper_title&&(a=b.directWrapper())&&a.titleOfWrapper)b.wrapper_title=a.titleOfWrapper();b.isSystemShadow()?(b.tiddler=null,b.wrapper=null,b.wrapper_title=null):b.tiddler||(b.tiddler=twve.tiddler.get(b.wrapper_title));return b};b.changed=function(b){return b.text};b.ensureValid=function(a){if(0>=
a)return 0;var d=b.tiddler.text.length;return a>=d?d:a};b.checkNewLines=function(a,d,e){b.newline_open="\n"==a.charAt(d);b.newline_close=e>d+1&&"\n"==a.charAt(e-1)};b.setText=function(a,d,e){var f=b.tiddler.text;"number"!=typeof d&&(d=b.start.ndx);"number"!=typeof e&&(e=b.end.ndx);d=b.ensureValid(d);e=b.ensureValid(e);var g=0;b.checkNewLines(f,d,e);a?(b.newline_open&&d++,b.newline_close&&e--,g=a.length-(e-d),f=f.substring(0,d)+a+f.substring(e)):(b.newline_open&&b.newline_close&&d++,f=f.substring(0,
d)+f.substring(e),g=-(e-d));a=b.directWrapper();a!=b&&(a.end.ndx+=g);b.end.ndx+=g;twve.tiddler.saveText(b,f);return b};b.getText=function(a,d){"number"!=typeof a&&(a=b.start.ndx);"number"!=typeof d&&(d=b.end.ndx);if(a>=d)return"";var e=b.tiddler.text;b.checkNewLines(e,a,d);b.newline_open&&a++;b.newline_close&&d--;return e.substring(a,d)};b.focusEditBox=function(a,d){d?a.select():a.focus();twve.tiddler.initCaretPos();return b};b.prepareEditBox=function(a,d,e,f,g){a.style.position="absolute";a.style.padding=
"0";a.style.margin="0";a.style.overflow="auto";a.style.textAlign=f;a.style.fontFamily="courier";a.style.fontSize=g+"px";twve.node.setPosition(a,e.left-1,e.top-1);twve.node.setDimension(a,e.width,e.height);a.setAttribute("scrH0",e.height);a.setAttribute("spellcheck","true");a.setAttribute("cancel","false");a.setAttribute("title","("+(b.multiLine(d)?"Ctrl-":"")+"ENTER=accept, ESC=cancel)");a.addEventListener("keydown",twve.tiddler.keydown);a.addEventListener("paste",twve.tiddler.paste);a.addEventListener("copy",
function(){twve.tiddler.copyOrCut()});a.addEventListener("cut",function(){twve.tiddler.copyOrCut(!0)})};b.previewEditBox=function(b,a,e){e=twve.tiddler.getPreviewer(e);twve.node.copyFontColor(e,a);twve.tiddler.previewEditBox(b,null);return e};b.editText=function(a,d,e){e||(e=b.getElement());twve.tiddler.cur_editable=b;void 0===d&&(d=b.getText());var f=document.createElement("textarea");f.value=d;f.defaultValue=d;var g=window.getComputedStyle(e),h=twve.node.cssSize(g.getPropertyValue("line-height")),
l=twve.node.cssSize(g.getPropertyValue("font-size")),k=twve.tiddler.focusBox()||b.box("edit",a,e);k.height<h&&(k.height=h);h=twve.node.closest(e,twve.tiddler.displaySelector());h.appendChild(f);b.prepareEditBox(f,d,k,g.getPropertyValue("text-align"),l);twve.node.setDimension(f,null,0);g=f.scrollHeight;g<k.height?g=k.height:k.height=g;twve.node.setDimension(f,null,g);twve.tiddler.setEditBox([f]);b.focusEditBox(f,d,a,e);b.previewEditBox(f,e,h);a=l*config.options.txttwveCoreMinEditWidth;twve.node.setDimension(f,
k.width<a?a:k.width);return f};b.hasClass=function(a){return b.dom.classList.contains(a)};b.saveText=function(a,d){return twve.tiddler.saveText(b,a,d)};return b.created(a)}};
twve.element={create:function(a){var b=twve.editable.create();b.clear=function(){b.direct_wrapper=null;b.rIndex=-1;b.dIndex=-1;b.tags=null;return b};var c=b.copyFrom;b.copyFrom=function(a){c.apply(this,arguments);b.direct_wrapper=a.direct_wrapper;b.rIndex=a.rIndex;b.dIndex=a.dIndex;b.tags=a.tags;return b};b.markupTags=function(){return twve.tiddler.markupTags(b.dom)};var d=b.directWrapper;b.directWrapper=function(){b.direct_wrapper||(b.direct_wrapper=d.apply(this,arguments));return b.direct_wrapper};
b.renderedCopy=function(a){var c=b.directWrapper();if(!c)return null;c=c.dom;if(c==a)return b;if(twve.node.contains(a,c))return null;c=-1;if(twve.text.tiddlerSection(b.wrapper_title)||twve.text.tiddlerSection(twve.tiddler.titleOfWrapper(a)))c=b.rIndex,b.rIndex=-1;a=twve.wrapper.renderedElement(b,a);-1<c&&(b.rIndex=c);return a};b.removeSelf=function(){b.dom.parentNode.removeChild(b.dom);twve.tiddler.focusElem(null);return b};b.replaceWith=function(a,c){twve.node.replace(a,c||b.dom);return b};b.filter=
function(a,c){c||(c=b.twveSelector(null,"rendering").include);if(a.nodeType)return twve.node.matches(a,c)?a:null;for(var d=[],e=0,k=a.length;e<k;e++)twve.node.matches(a[e],c)&&(d[d.length]=a[e]);return 0==d.length?null:1<d.length?d:d[0]};b.refreshSelf=function(a){a=twve.tiddler.getPreviewedNodes(a);var c=b.filter(a)||a[0];b.replaceWith(a);b.dIndex=-1;b.setElement(c);return b};b.refreshAll=function(a,c){var d=null,e=config.options.chkAnimate;config.options.chkAnimate=!1;var k=twve.text.tiddlerSection(b.wrapper_title);
"string"!=typeof a&&(a=b.getText());b.findWrappers();for(var m=0,n=b.wrapper.length;m<n;m++){var d=b.wrapper[m],q=twve.tiddler.titleOfWrapper(d),p=twve.text.tiddlerSection(q);if(!k||!(p&&p!=k)){var r=b.renderedCopy(d);if(r)(d=r.foldedWrapper())&&twve.node.show(d.dom),a?(r.refreshSelf(a),c&&c.what&&r.changed(c)):r.removeSelf(c),d&&twve.node.hide(d.dom);else if(!p&&(p=twve.text.tiddlerSlice(q)))(r=twve.tiddler.createEditableWrapper(d))&&r.refreshSelf(p)}}config.options.chkAnimate=e;return b};b.renderingIndex=
function(){if(0>b.rIndex){var a=b.directWrapper().findElements(b.twveSelector(null,"rendered"));a&&(b.rIndex=a.indexOf(b.dom))}return b.rIndex};b.counts=function(b){b.remained--;b.ndx++;return!0};b.starts=function(a,c){if(!c&&!b.tiddler||!b.tags||!b.tags.open)return b.start.ndx=-1,b.start;c||(c=b.tiddler.text);b.start.ensureValid(a||b.directWrapper().start);var d=twve.object.create();d.remained=-1<b.rIndex?b.rIndex+1:-1<b.dIndex?b.dIndex+1:1;d.ndx=-1;var e=twve.tags.inactiveTags();do{b.start=b.tags.nextOpenTag(c,
b.start,e);if(0>b.start.ndx)return b.start.ndx=-d.remained,b.start;if(b.counts(d,c)){if(0==d.remained)return-1==b.dIndex&&(b.dIndex=d.ndx),-1==b.rIndex&&(b.rIndex=d.ndx),b.start;b.start.ndx=b.ends(null,c,e).ndx}else b.start.ndx+=b.start.matched.length}while(1)};b.ends=function(a,c,d){!a||a==b.start?a=twve.position.create(b.start):"number"==typeof a?a=twve.position.create(a):a.ensureValid();a.ndx++;c||(c=b.tiddler.text);var e=b.tags.exactCloseTag(a.matched);b.end.copyFrom(e.matchedCloseTag(c,a,c.length,
d));b.end.ndx=-1==b.end.ndx?c.length:b.end.ndx+b.end.matched.length;return b.end};var e=b.setElement;b.setElement=function(a,c){if(!a)return b.clear();if("string"==typeof a)b.dom=a,b.tags=twve.tiddler.markupTags(a);else{if(!e.apply(this,arguments)||!b.tiddler)return b;0>b.rIndex&&0>b.dIndex&&b.renderingIndex();b.tags||(b.tags=b.markupTags());var d=c?twve.position.create():null;b.starts(d,c);0<=b.start.ndx?b.ends(null,c):b.end.ndx=-1}return b};b.updateText=function(a){b.setText(a[0]);return b.refreshAll(a[0])};
return b.created(a)}};
twve.pre={enableEdit:!0,twveSelector:function(a,b){a||(a=twve.selector.create());var c="pre,div.syntaxhighlighter";/^render/i.test(b)||(c+=",div.alt1,div.alt2,.syntaxhighlighter code,.syntaxhighlighter table");a.includeSelector(c);return a},markupTags:function(){var a=twve.tags.create(["\n{{{","\n//{{{","\n/*{{{*/","\n\x3c!--{{{--\x3e"],["}}}\n","//}}}\n","/*}}}*/\n","\x3c!--}}}--\x3e\n"]);a.blockElement=!0;a.clone=function(){return twve.pre.markupTags()};return a},create:function(a){var b=twve.element.create();
b.markupTags=function(){return twve.pre.markupTags()};b.clone=function(){return twve.pre.create(b)};b.twveSelector=function(b,a){return twve.pre.twveSelector(b,a)};var c=b.setElement;b.setElement=function(b){twve.node.matches(b,"pre")||(b=twve.node.closest(b,"div.syntaxhighlighter"));return c.call(this,b)};return b.created(a)}};
twve.code={enableEdit:!0,twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("code");a.excludeSelector(".syntaxhighlighter code");return a},markupTags:function(){return twve.tags.create("{{{","}}}")},create:function(a){var b=twve.element.create();b.markupTags=function(){return twve.code.markupTags()};b.clone=function(){return twve.code.create(b)};b.twveSelector=function(){return twve.code.twveSelector()};b.counts=function(a,d){return"\n"!=d.charAt(b.start.ndx+b.start.matched.length)?
(a.remained--,a.ndx++,!0):!1};return b.created(a)}};
twve.leveledElement={getLevel:function(a,b,c){var d=0;if(c){if(/\s/.test(c))return 0}else{c=a.charAt(b);if(!c||/\s/.test(c))return 0;d++}for(var e=a.length;b+d<e&&-1<c.indexOf(a.charAt(b+d));)d++;return d},create:function(a){var b=twve.element.create();b.clear=function(){b.level=0;return b};var c=b.copyFrom;b.copyFrom=function(a){c.apply(this,arguments);b.level=a.level;return b};b.getLevel=function(a,c){if(1>b.level){a||(a=b.tiddler.text);c||(c=b.start);var d=c.ndx;"\n"==a.charAt(d)&&d++;b.level=
twve.leveledElement.getLevel(a,d)}return b.level};b.getOpenTag=function(a,c){c||(c=b.tiddler?b.tiddler.text:"");if(!c)return"";a||(a=b.start);var d=b.getLevel(c,a),h="";"\n"==c.charAt(a.ndx)?d++:h="\n";return h+c.substring(a.ndx,a.ndx+d)};var d=b.starts;b.starts=function(a,c){d.apply(this,arguments);b.level=-1;-1<b.start.ndx&&(b.start.matched=b.getOpenTag(b.start,c));return b.start};return b.created(a)}};
twve.heading={enableEdit:!0,getSelector:function(){return"h1,h2,h3,h4,h5,h6"},getSpanSelector:function(a){return"span.TiddlyLinkExisting"},twveSelector:function(a,b){a||(a=twve.selector.create());a.includeSelector(/^fold/i.test(b)?"h1.foldable,h2.foldable,h3.foldable,h4.foldable,h5.foldable,h6.foldable":twve.heading.getSelector()+(/^render/i.test(b)?"":","+twve.heading.getSpanSelector()));return a},markupTags:function(){var a=twve.tags.create("\n!","\n");a.blockElement=!0;return a},getTitle:function(a,
b){var c=null;a.dom?c=a.dom:(c=a,a=null);if(!c)return null;if(0<c.childNodes.length){var d=twve.heading.create(a);d.setElement(c);return twve.text.sectionTitle(d.getText())}var e=c.textContent,d="";config.macros.foldHeadings&&(d=config.macros.foldHeadings.hidelabel,-1==e.indexOf(d)&&(d=config.macros.foldHeadings.showlabel,-1==e.indexOf(d)&&(d="")));e=d?e.substring(d.length).trim():e;if(!b&&(d=twve.heading.create(a),d.setElement(c),d=d.directWrapper().findElements(twve.heading.twveSelector(null,"rendered")))){for(var c=
d.indexOf(c),f=0,g=0;g<c;g++)twve.heading.getTitle(d[g],!0)==e&&f++;0<f&&(e+="?"+f)}return e},preClick:null,click:function(){var a=twve.tiddler.focusElem();(!a||!a.is(this)||a.indexOf&&-1==a.indexOf(this))&&twve.heading.preClick.apply(this,arguments)},prepareElements:function(a){if(config.options.chktwveCoreEnabled&&!a.isSystemShadow()){for(var b=a.dom.querySelectorAll(twve.heading.twveSelector(null,"foldable").include),c=0,d=b.length;c<d;c++)twve.heading.preClick||(twve.heading.preClick=b[c].onclick),
b[c].onclick=twve.heading.click;return a}return null},create:function(a){var b=twve.leveledElement.create();b.twveSelector=function(a,b){return twve.heading.twveSelector(a,b)};b.markupTags=function(){return twve.heading.markupTags()};b.getTitle=function(a){return twve.heading.getTitle(b,a)};var c=b.setElement;b.setElement=function(a){c.call(this,twve.node.matches(a,twve.heading.getSpanSelector())?a.parentNode:a);return b};b.mouseenter=function(a){var c=twve.heading.getSpanSelector();return!b.dom.querySelector(c)?
!0:twve.node.matches(a.target,c)};b.mousemove=function(a){b.mouseenter(a)||twve.tiddler.focus()};b.is=function(a){return twve.node.is(b.dom,twve.node.matches(a,twve.heading.getSpanSelector())?a.parentNode:a)};b.isEditable=function(a){var c=twve.heading.getSpanSelector();return twve.node.matches(a,c)?!0:0==b.dom.querySelectorAll(c).length};return b.created(a)}};
twve.wrapper={recordFoldable:function(a){var b=null;if(a)for(var b=[],c=0,d=a.length;c<d;c++)b[c]=!twve.node.isVisible(a[c]);return b},restoreFoldable:function(a,b){if(a){var c=config.options.chkAnimate;config.options.chkAnimate=!1;for(var d=b?Math.min(b.length,a.length):a.length,e=0;e<d;e++)if(a[e]&&(!b||b[e]&&twve.node.isVisible(a[e])||!b[e]&&!twve.node.isVisible(a[e]))&&a[e].previousSibling){var f=document.createEvent("MouseEvent");f.initEvent("click",!0,!0);a[e].previousSibling.dispatchEvent(f)}config.options.chkAnimate=
c}},renderedElement:function(a,b,c){if(!a||0>a.rIndex&&0>a.dIndex&&!c)return null;b||(b=a.directWrapper().dom);var d=twve.wrapper.findElements(b,a.twveSelector(null,"rendered"));if(!d)return null;var e=d.length;a=a.clone();if(c)0>a.rIndex?a.rIndex=e-1:a.rIndex>=e&&(a.rIndex=0);else{if(0>a.rIndex)return a.wrapper=b,a.direct_wrapper=twve.tiddler.createEditableWrapper(b,!0),a.wrapper_title=a.direct_wrapper.wrapper_title,a.starts(),0<=a.rIndex?(a.ends(),a.dom=d[a.rIndex],a):null;if(a.rIndex>=e)return null}c=
d[a.rIndex];0>a.dIndex?a.setElement(c):a.dom=c;a.direct_wrapper.dom!=b&&(a.wrapper=b,a.direct_wrapper=twve.tiddler.createEditableWrapper(b,!0),a.wrapper_title=a.direct_wrapper.wrapper_title);return a},findElements:function(a,b){if(!a||!b)return null;if("string"==typeof b)b=twve.selector.create(b,"");else if(!b.include)return null;for(var c=twve.nodeList.toArray(a.querySelectorAll(b.include)),d=twve.tiddler.twveTranscludedSelectors(),d=a.querySelectorAll(d.include),e=0,f=d.length;e<f;e++)c=twve.node.not(c,
d[e].querySelectorAll(b.include));b.exclude&&(c=twve.node.not(c,b.exclude));return 0<c.length?c:null},create:function(a){var b=twve.editable.create();b.isWrapper=function(){return!0};b.directWrapper=function(){return b};b.titleOfWrapper=function(){return twve.tiddler.titleOfWrapper(b.dom)};b.isEditable=function(a){return b.dom==a?!0:twve.node.contains(b.dom,a)&&!twve.node.matches(a,twve.heading.twveSelector().include)};b.findElements=function(a){return twve.wrapper.findElements(b.dom,a||b.twveSelector(null,
"rendered"))};b.starts=function(a,c){b.start.ensureValid(c);a||(a=twve.text.tiddlerSection(b.wrapper_title));if(!a)return b.start;var d=twve.text.headerToSkip(a);0<d&&(a=twve.text.removeHeaderTail(a));var h=twve.heading.create();h.dIndex=0;h.tiddler=b.tiddler;h.end.ndx=b.start.ndx;for(h.tags=twve.heading.markupTags();0<=d;){h.starts(h.end);if(-1==h.start.ndx)break;h.ends();twve.text.sectionTitle(h.getText()).substring(0,a.length)==a&&d--}b.start.ndx=h.end.ndx;return b.start};b.ends=function(){if(twve.text.tiddlerSection(b.wrapper_title)){var a=
twve.heading.create();a.dIndex=0;a.tiddler=b.tiddler;a.tags=twve.heading.markupTags();a.start.ndx=b.start.ndx;a.starts(a.start);b.end.ndx=0>a.start.ndx?b.tiddler.text.length:a.start.ndx}else b.end.ndx=b.tiddler.text.length;return b.end};var c=b.setElement;b.setElement=function(a){if(!a)return b.clear();if(!c.apply(this,arguments)||!b.tiddler)return b;b.starts();b.ends();return b};b.refreshSelf=function(a,c){if(!b.tiddler)return b;var d=twve.tiddler.twveFoldableSelector(),h=b.findElements(d),l=twve.wrapper.recordFoldable(h);
for(c||(c=a?b.getText("refresh"):b.tiddler.text);b.dom.firstChild;)b.dom.removeChild(b.dom.firstChild);for(var h=twve.tiddler.getPreviewedNodes(c),k=0,m=h.length;k<m;k++)b.dom.appendChild(h[0]);h=b.findElements(d);return b.checkAndPrepare(h,l)};b.refreshAll=function(a){var c=config.options.chkAnimate;config.options.chkAnimate=!1;var d=b.sliceKey?twve.text.tiddlerSlice(b.wrapper_title):twve.text.tiddlerSection(b.wrapper_title),h=window.pageXOffset,l=window.pageYOffset;b.findWrappers();for(var k=0,
m=b.wrapper.length;k<m;k++){var n=b.wrapper[k];if(n==b.dom)b.refreshSelf(d,a);else{var q=twve.tiddler.createEditableWrapper(n);if(q){var p=twve.text.tiddlerSection(q.wrapper_title)||twve.text.tiddlerSlice(q.wrapper_title);if((!d||!p||p==d)&&!twve.node.contains(n,b.dom)&&!twve.node.contains(b.dom,n))(n=!twve.node.isVisible(n)?n:null)&&twve.node.show(n),q.refreshSelf(p,a),n&&twve.node.hide(n)}}}window.scrollTo(h,l);config.options.chkAnimate=c;return b};b.updateText=function(a){b.setText(a[0]);return b.refreshAll(a[0])};
b.multiLine=function(){return!0};b.checkAndPrepare=function(a,c){if(!b.dom)return b;var d=b.isVisible()?null:b.dom,h=config.options.chkAnimate;config.options.chkAnimate=!1;d&&twve.node.show(d);void 0===a&&(a=b.findElements(twve.tiddler.twveFoldableSelector()),c=twve.wrapper.recordFoldable(a));a&&twve.node.show(a);b.dom&&twve.wrapper.prepareElements(b);a&&twve.wrapper.restoreFoldable(a,c);d&&twve.node.hide(d);config.options.chkAnimate=h;return b};var d=null;b.wait=function(){anim.running||(clearInterval(d),
b.checkAndPrepare())};b.waitAndPrepare=function(){d=null;config.options.chktwveCoreEnabled&&(config.options.chkAnimate&&anim.running?d=setInterval(b.wait,50):b.checkAndPrepare())};return b.created(a)}};
twve.viewer={enableEdit:!0,twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("div.viewer");return a},titleOfWrapper:function(a){return(a=twve.node.closest(a,"[tiddler]"))?a.getAttribute("tiddler"):""},wrapperFromTitle:function(a,b){return twve.nodeList.querySelectorAll(b,'div[tiddler*="'+a+'"] .viewer')},create:function(a){var b=twve.wrapper.create(a);b.clone=function(){return twve.viewer.create(b)};return b}};
twve.tabContent={enableEdit:!0,getSelector:function(){return"div.tabContents"},twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("div.tabContents");return a},titleOfWrapper:function(a){return a.parentNode.querySelector(".tabSelected").getAttribute("content")},wrapperFromTitle:function(a,b){var c=twve.nodeList.querySelectorAll(b,'.tabSelected[content*="'+a+'"]');if(!c)return null;for(var d=0,e=c.length;d<e;d++)c[d]=c[d].parentNode.nextSibling;return c},create:function(a){var b=
twve.wrapper.create();b.clone=function(){return twve.tabContent.create(b)};return b.created(a)}};twve.transcludedElem={create:function(a){if(a){var b=twve.tiddler.focusElem();if(b&&b.dom==a.parentNode)return twve.element.create()}return null}};
twve.tiddlerSpan={enableEdit:!0,getSelector:function(){return"span[tiddler]"},twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("span[tiddler]");return a},titleOfWrapper:function(a){return a.getAttribute("tiddler")},wrapperFromTitle:function(a,b){return twve.nodeList.querySelectorAll(b,'span[tiddler*="'+a+'"]')},markupTags:function(){var a=twve.tags.create("<<tiddler",">>");a.blockElement=!0;return a},create:function(a){var b=twve.wrapper.create();b.markupTags=function(){return twve.tiddlerSpan.markupTags()};
b.clone=function(){return twve.tiddlerSpan.create(b)};var c=b.starts;b.starts=function(){b.sliceKey=twve.text.tiddlerSlice(b.wrapper_title);if(!b.sliceKey)return c.apply(this,arguments);var a=b.tiddler.text;for(store.slicesRE.lastIndex=0;;){var d=store.slicesRE.exec(a);if(!d)break;if(d[2]){if(d[2]==b.sliceKey){b.sliceValue=d[3];b.start.ndx=d.index;b.end.ndx=store.slicesRE.lastIndex;break}}else if(d[5]==b.sliceKey){b.sliceValue=d[6];b.start.ndx=d.index;b.end.ndx=store.slicesRE.lastIndex-1;break}}return b.start};
var d=b.ends;b.ends=function(){return b.sliceKey?b.end:d.apply(this,arguments)};var e=b.getText;b.getText=function(){return b.sliceKey?b.sliceValue||"":e.apply(this,arguments)};var f=b.setText;b.setText=function(a){if(!b.sliceKey)return f.apply(this,arguments);var c=b.tiddler.text,d,e,m=0;b.sliceValue?(d=c.indexOf(b.sliceValue,b.start.ndx),m=b.sliceValue.length,e=d+m):e=d=b.end.ndx;c=c.substring(0,d)+a+c.substring(e);b.end.ndx+=(a?a.length:0)-m;b.sliceValue=a;twve.tiddler.saveText(b,c);return b};
return b.created(a)}};
twve.sliderPanel={enableEdit:!0,getSelector:function(){return"div.sliderPanel"},twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector(twve.sliderPanel.getSelector());return a},titleOfWrapper:function(a){return a.getAttribute("tiddler")},wrapperFromTitle:function(a,b){return twve.nodeList.querySelectorAll(b,'div.sliderPanel[tiddler*="'+a+'"]')},markupTags:function(){var a=twve.tags.create("<<slider",">>");a.blockElement=!0;return a},create:function(a){var b=twve.transcludedElem.create(a)||
twve.wrapper.create();b.markupTags=function(){return twve.sliderPanel.markupTags()};b.clone=function(){return twve.sliderPanel.create(b)};return b.created(a)}};twve.foldedSection={macro:function(){return"<<foldHeadings>>"},enableEdit:!0,getSelector:function(){return"span.sliderPanel"},twveSelector:function(a){a||(a=twve.selector.create());twve.foldedSection.enableEdit&&a.includeSelector("span.sliderPanel");return a}};
twve.tiddlerTitle={enableEdit:!0,twveSelector:function(a){a||(a=twve.selector.create());a.includeSelector("div.title");return a},titleOfWrapper:function(a){return a.textContent},create:function(a){var b=twve.wrapper.create();b.setText=function(a){twve.tiddler.saveText(b,null,a);return b};b.getText=function(){return b.tiddler.title};b.mouseleave=function(a){var b=twve.tiddler.getOptionsMenu();if(b.dom==a.relatedTarget)return!1;b.hide(!0);return!0};b.blur=function(){twve.tiddler.getOptionsMenu().hide(!0)};
b.multiLine=function(){return!1};b.box=function(a){var d=twve.node.box(b.dom);/focus/i.test(a)&&(a=twve.object.create(),a.left=d.right,a.top=d.top,twve.tiddler.getOptionsMenu().showRoot(a,"left"));return twve.tiddler.editWrappers()?d:null};b.isWrapper=function(){return!1};b.titleOfWrapper=function(){return b.dom.textContent};return b.created(a)}};
//}}}
// @@
